# PIS Deployment Guide

> Author: junyuzhan (junyuzhan@outlook.com)  
> License: MIT

## Table of Contents

1. [ðŸš€ Quick Start (One-Click Deployment)](#-quick-start-one-click-deployment) - Fastest way to deploy
2. [Architecture Overview](#architecture-overview)
3. [Prerequisites](#prerequisites)
4. [Supabase Configuration](#supabase-configuration)
5. [Local Development Environment](#local-development-environment)
6. [Production Deployment](#production-deployment)
7. [Environment Variables](#environment-variables)
8. [Verification & Testing](#verification--testing)
9. [Maintenance & Operations](#maintenance--operations)
10. [Troubleshooting](#troubleshooting)

---

## ðŸš€ Quick Start (One-Click Deployment)

> **Fastest way to deploy PIS on your server**

### Guided Deployment Script

The new guided deployment script provides an interactive setup experience with automatic secret generation.

**SSH into your server and run:**

```bash
# Clone the repository
git clone https://github.com/JunyuZhan/pis-standalone.git
cd pis-standalone

# Run guided deployment (interactive)
bash docker/deploy.sh
```

**Or deploy from your local machine:**

```bash
git clone https://github.com/JunyuZhan/pis-standalone.git
cd pis-standalone

# Deploy to remote server
bash docker/deploy.sh <server-ip> <ssh-user>
# Example: bash docker/deploy.sh 192.168.1.100 root
```

### Deployment Modes

The script will guide you to choose between two deployment modes:

| Mode | Description | Best For |
|------|-------------|----------|
| **Fully Standalone**ï¼ˆRecommendedï¼‰ | All services containerized (PostgreSQL + MinIO + Redis + Web + Worker + Nginx) | Complete self-hosting, data privacy |
| **Hybrid**ï¼ˆOptionalï¼‰ | Vercel (frontend) + Supabase (database) + Your server (storage/worker) | Quick setup, cloud frontend |

### Deployment Flow

```
Step 1: Choose deployment mode (Hybrid / Standalone)
Step 2: Install environment (Docker, Git)
Step 3: Configure database (PostgreSQL credentials, or optional Supabase URL)
Step 4: Configure storage (MinIO / Cloud storage)
Step 5: Auto-generate security secrets
Step 6: Build and start services
Step 7: Configure SSL/TLS (Let's Encrypt)
Step 8: Verify deployment
```

### Auto-Generated Secrets

The deployment script automatically generates secure random values for:
- `STORAGE_ACCESS_KEY`, `STORAGE_SECRET_KEY` (MinIO credentials)
- `WORKER_API_KEY` (Worker API authentication)
- `ALBUM_SESSION_SECRET` (JWT session signing)
- `REDIS_PASSWORD` (Redis authentication)
- `POSTGRES_PASSWORD` (PostgreSQL password in standalone mode)

### Database Options

| Type | Recommended For | Features |
|------|-----------------|----------|
| **PostgreSQL**ï¼ˆRecommendedï¼‰ | Standalone deployment | Self-hosted, local Docker, full control |
| **Supabase**ï¼ˆOptionalï¼‰ | Hybrid deployment | Cloud-hosted, includes auth, requires internet |
| **MySQL** | Standalone deployment | Self-hosted, local Docker |

### PostgreSQL Configuration (Recommended)

PostgreSQL is the default and recommended database option, providing complete data control:

```bash
# Database connection info
DATABASE_HOST=postgres          # Docker service name or host address
DATABASE_PORT=5432
DATABASE_NAME=pis
DATABASE_USER=pis
DATABASE_PASSWORD=AUTO_GENERATE # Auto-generated by deployment script
```

### Getting Supabase Credentials (Optional, Hybrid Mode)

If choosing hybrid mode, Supabase credentials are needed:

1. Visit https://supabase.com/dashboard
2. Select project â†’ **Settings** â†’ **API**
3. Copy **Project URL** and **service_role key**

### Server Requirements

- **OS**: Ubuntu 20.04+ / Debian 11+ / CentOS 7+
- **Specs**:
  - Hybrid: 1 core, 1GB RAM minimum
  - Standalone: 2 cores, 2GB RAM minimum, 4GB recommended
- **Ports**:
  - Standalone: 80 (HTTP), 443 (HTTPS)
  - Hybrid: 9000, 9001, 3001 (can be internal)

### Post-Deployment Configuration

#### Standalone Mode

All services are accessible via your domain:
```
https://yourdomain.com          # Main application
https://yourdomain.com/media    # Media files
```

#### Hybrid Mode

1. **Access MinIO Console** (if using MinIO):
   ```
   http://your-server-ip:9001
   ```

2. **Initialize Database Schema** (PostgreSQL):
   âš ï¸ **Important**: Execute database migration script (`docker/init-postgresql-db.sql`) in PostgreSQL database.

3. **Deploy Frontend to Vercel**:
   - Connect your GitHub repository
   - Configure environment variables
   - Deploy

### Common Commands

```bash
# Standalone mode - View logs
cd /opt/pis/docker && docker-compose -f docker-compose.standalone.yml logs -f

# Standalone mode - Restart services
cd /opt/pis/docker && docker-compose -f docker-compose.standalone.yml restart

# Update code
cd /opt/pis && git pull && cd docker && docker-compose -f docker-compose.standalone.yml up -d --build
```

### Quick Troubleshooting

**Q: Deployment failed?**

```bash
cd /opt/pis/docker && docker-compose -f docker-compose.standalone.yml logs
```

**Q: Port already in use?**

```bash
ss -tuln | grep -E ":(80|443|9000|9001|3001)"
```

> ðŸ’¡ **Need more details?** Continue reading the full deployment guide below.

---

## Architecture Overview

> âš ï¸ **Important**: The following is an **example deployment architecture**. PIS supports multiple deployment options:
> - **Frontend**: Vercel, self-hosted, Docker, K8s, or any platform supporting Next.js
> - **Worker**: Standalone server, Docker, K8s, Cloud Functions, etc.
> - **Storage**: MinIO, OSS, COS, S3, or any S3-compatible storage
> - **Database**: Supabase, PostgreSQL, MySQL
> - **Reverse Proxy**: frpc, nginx, Caddy, Traefik, etc. (optional, not needed if services are on the same network)

**Example Deployment Architecture**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            Internet                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                     â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Vercel     â”‚    â”‚   Supabase    â”‚    â”‚      Internal Server          â”‚
â”‚  (Next.js)    â”‚    â”‚    Cloud      â”‚    â”‚                               â”‚
â”‚               â”‚    â”‚               â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â€¢ Frontend   â”‚    â”‚  â€¢ PostgreSQL â”‚    â”‚  â”‚  MinIO  â”‚  â”‚   Worker    â”‚ â”‚
â”‚  â€¢ API Routes â”‚    â”‚  â€¢ Auth       â”‚    â”‚  â”‚(Storage)â”‚  â”‚(Processing) â”‚ â”‚
â”‚  â€¢ SSR/SSG    â”‚    â”‚  â€¢ Realtime   â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚               â”‚    â”‚               â”‚    â”‚       â–²              â”‚        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
        â”‚                    â”‚            â”‚              Redis            â”‚
        â”‚                    â”‚            â”‚         (Task Queue)          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| Component | Example Deployment | Purpose |
|-----------|-------------------|---------|
| Next.js Frontend | Vercel (example) | User interface, API routes |
| PostgreSQL | Supabase (example) | Metadata storage |
| Auth | Supabase (example) | User authentication |
| Realtime | Supabase (example) | Real-time push |
| MinIO | Internal Docker (example) | Photo storage |
| Worker | Internal Docker (example) | Image processing |
| Redis | Internal Docker (example) | Task queue |

**Other Deployment Options**:
- **Fully Self-Hosted**: All services on the same server with nginx/Caddy
- **Cloud-Native**: Vercel + Cloud Functions + S3 + Supabase
- **Hybrid**: Self-hosted frontend + Cloud storage + Cloud database
- **Containerized**: Docker Compose or Kubernetes for all services

---

## Prerequisites

### Local Development

- **Node.js** >= 20.0.0
- **pnpm** >= 9.0.0
- **Docker** & Docker Compose
- **Git**

### Production Deployment

PIS supports flexible deployment options. Example requirements:

- A Linux server (recommended 2 cores 4GB+) - *if self-hosting Worker*
- Docker installed - *if using Docker deployment*
- Domain names - *optional, depends on your deployment*
- Supabase account (free tier is fine) - *or use PostgreSQL/MySQL*
- Vercel account (free tier is fine) - *or use other hosting platforms*

---

## Supabase Configuration

### 1. Create Project

1. Visit [https://supabase.com](https://supabase.com) and log in
2. Click **New Project**
3. Fill in project information:
   - **Name**: `pis`
   - **Database Password**: Set a strong password and save it
   - **Region**: Choose the region closest to you (recommended: Singapore)
4. Click **Create new project**, wait 2-3 minutes

### 2. Get API Keys

Go to project â†’ **Settings** â†’ **API**, copy the following information:

| Name | Purpose | Example |
|------|---------|---------|
| Project URL | All clients | `https://xxxxx.supabase.co` |
| anon public | Frontend browser | `eyJhbGciOiJIUzI1NiIs...` |
| service_role | Worker backend | `eyJhbGciOiJIUzI1NiIs...` (âš ï¸ Keep secret!) |

### 3. Execute Database Schema

1. Go to project â†’ **SQL Editor**
2. Click **New query**
3. Execute database migration scripts (see project documentation or Supabase migrations)
4. Click **Run** to execute
5. âœ… Done!

**Or use command line**:
```bash
# Use Supabase CLI or other migration tools to execute database schema
```

### 4. Create Admin Account

> âš ï¸ **Important**: You must create an admin account before you can access the admin dashboard.

**Steps:**

1. Go to **Authentication** â†’ **Users** in Supabase Dashboard
2. Click **Add user** â†’ **Create new user**
3. Fill in the form:
   - **Email**: Your admin email (e.g., `admin@example.com`)
   - **Password**: Set a strong password (at least 8 characters)
   - âœ… **Auto Confirm User** (check this box - important!)
4. Click **Create user**
5. âœ… Done! You can now use this email and password to log in at `/admin/login`

**Note**: 
- The email and password you create here will be used to log in to the admin dashboard
- Make sure to check "Auto Confirm User" so you can log in immediately
- You can create multiple admin accounts if needed

### 5. Configure Auth URLs

1. Go to **Authentication** â†’ **URL Configuration**
2. Set:

| Configuration | Value |
|--------------|-------|
| Site URL | `https://yourdomain.com` |
| Redirect URLs | `https://yourdomain.com/auth/callback` |
| | `http://localhost:3000/auth/callback` |

### 6. Enable Realtime (Optional but Recommended)

1. Go to **Database** â†’ **Replication**
2. Click **Tables** tab
3. Find `photos` table, toggle to enable

---

## Local Development Environment

### 1. Clone and Install

```bash
git clone https://github.com/your-username/pis.git
cd pis-standalone
pnpm install
```

### 2. Start Base Services

```bash
cd docker
docker-compose up -d minio redis minio-init
```

Verify services started:
```bash
docker-compose ps
# Should see pis-minio and pis-redis status as Up (healthy)
```

### 3. Configure Environment Variables

**apps/web/.env:**

```bash
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# Application Configuration
NEXT_PUBLIC_APP_URL=http://localhost:3000
NEXT_PUBLIC_MEDIA_URL=http://localhost:9000/pis-photos
```

**services/worker/.env:**

```bash
# Supabase
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# MinIO (Local Docker)
MINIO_ENDPOINT_HOST=localhost
MINIO_ENDPOINT_PORT=9000
MINIO_USE_SSL=false
MINIO_ACCESS_KEY=minioadmin
MINIO_SECRET_KEY=minioadmin
MINIO_BUCKET=pis-photos

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379
```

### 4. Start Development Server

```bash
# Terminal 1: Start Worker
cd services/worker
pnpm dev

# Terminal 2: Start Frontend
cd ../..   # Back to project root
pnpm dev
```

### 5. Access Application

| URL | Description |
|-----|-------------|
| http://localhost:3000 | Frontend homepage |
| http://localhost:3000/admin/login | Admin dashboard login |
| http://localhost:9001 | MinIO Console (minioadmin/minioadmin) |

---

## Production Deployment

### Server Side (Docker)

#### 1. Prepare Server

```bash
# Install Docker (Ubuntu/Debian)
curl -fsSL https://get.docker.com | sh
sudo usermod -aG docker $USER

# Install Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

#### 2. Upload Project Files

Upload the following files to server `/opt/pis/`:

```
/opt/pis/
â”œâ”€â”€ docker/
â”‚   â”œâ”€â”€ docker-compose.yml
â”‚   â”œâ”€â”€ worker.Dockerfile
â”‚   â””â”€â”€ nginx/
â”‚       â””â”€â”€ media.conf
â”œâ”€â”€ services/
â”‚   â””â”€â”€ worker/
â”‚       â”œâ”€â”€ package.json
â”‚       â”œâ”€â”€ tsconfig.json
â”‚       â””â”€â”€ src/
â””â”€â”€ .env
```

#### 3. Configure Environment Variables

Create `/opt/pis/.env`:

```bash
# Supabase
SUPABASE_URL=https://xxxxx.supabase.co
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# MinIO (Custom strong password!)
MINIO_ACCESS_KEY=your-strong-access-key
MINIO_SECRET_KEY=your-strong-secret-key-at-least-8-chars

# Redis
REDIS_HOST=redis
REDIS_PORT=6379
```

#### 4. Start Services

```bash
cd /opt/pis/docker
docker-compose up -d

# Check status
docker-compose ps

# View logs
docker-compose logs -f
```

#### 5. Configure Nginx Reverse Proxy

Create `/etc/nginx/sites-available/media.yourdomain.com`:

```nginx
server {
    listen 80;
    server_name media.yourdomain.com;

    # Redirect to HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name media.yourdomain.com;

    # SSL Certificate (Let's Encrypt)
    ssl_certificate /etc/letsencrypt/live/media.yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/media.yourdomain.com/privkey.pem;

    # Allow large file uploads
    client_max_body_size 100M;

    location / {
        proxy_pass http://127.0.0.1:9000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Cache static resources
        proxy_cache_valid 200 7d;
        add_header Cache-Control "public, max-age=604800";

        # CORS
        add_header Access-Control-Allow-Origin "*";
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
    }
}
```

Enable configuration:
```bash
sudo ln -s /etc/nginx/sites-available/media.yourdomain.com /etc/nginx/sites-enabled/
sudo certbot --nginx -d media.yourdomain.com
sudo nginx -t && sudo nginx -s reload
```

### Vercel Deployment

#### 1. Connect Repository

1. Visit [https://vercel.com](https://vercel.com) and log in
2. Click **Add New Project**
3. Select your GitHub repository

#### 2. Configure Build

| Configuration | Value |
|--------------|-------|
| Framework Preset | Next.js |
| Root Directory | `apps/web` |
| Build Command | `pnpm build` |
| Install Command | `pnpm install` |

#### 3. Configure Environment Variables

In **Settings** â†’ **Environment Variables** add:

**Required Variables:**
```
NEXT_PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
NEXT_PUBLIC_APP_URL=https://yourdomain.com
NEXT_PUBLIC_MEDIA_URL=https://media.yourdomain.com/pis-photos
NEXT_PUBLIC_WORKER_URL=https://worker.yourdomain.com
WORKER_API_KEY=your-generated-api-key
```

**Optional Variables (Recommended):**
```
NEXT_PUBLIC_PHOTOGRAPHER_NAME=Your Studio Name
NEXT_PUBLIC_PHOTOGRAPHER_TAGLINE=Professional Photography
NEXT_PUBLIC_TURNSTILE_SITE_KEY=your-turnstile-site-key
TURNSTILE_SECRET_KEY=your-turnstile-secret-key
```

> ðŸ’¡ **Note**: 
> - All URLs should use `https://` in production
> - `NEXT_PUBLIC_*` variables are exposed to the browser
> - Never set sensitive keys as `NEXT_PUBLIC_*`

#### 4. Deploy

Click **Deploy**, wait for build to complete.

#### 5. Bind Domain

1. **Settings** â†’ **Domains**
2. Add `yourdomain.com`
3. Configure DNS as prompted (CNAME or A record)

---

## Configuration

### Storage

Supports MinIO, OSS, COS, S3. Configure `STORAGE_TYPE` and related environment variables. See `.env.example` for details.

### Database

Supports Supabase (recommended), PostgreSQL, MySQL. Configure `DATABASE_TYPE` and related environment variables. See `.env.example` for details.

### CDN

Configure CDN to improve image loading speed:
1. Add media server domain to CDN
2. Configure cache rules (long-term cache for thumbnails/previews)
3. Update `NEXT_PUBLIC_MEDIA_URL` to point to CDN address
4. (Optional) Configure `CLOUDFLARE_API_TOKEN` and `CLOUDFLARE_ZONE_ID` for automatic cache purging

---

## Environment Variables

### Frontend (Vercel / apps/web/.env)

| Variable | Description | Example |
|----------|-------------|---------|
| `NEXT_PUBLIC_SUPABASE_URL` | Supabase project URL | `https://xxx.supabase.co` |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | Supabase anonymous key | `eyJ...` |
| `SUPABASE_SERVICE_ROLE_KEY` | Supabase service role key | `eyJ...` |
| `NEXT_PUBLIC_APP_URL` | Application access URL | `https://yourdomain.com` |
| `NEXT_PUBLIC_MEDIA_URL` | Media CDN address | `https://media.yourdomain.com/pis-photos` |

### Worker (Docker / .env)

| Variable | Description | Example |
|----------|-------------|---------|
| `SUPABASE_URL` | Supabase project URL | `https://xxx.supabase.co` |
| `SUPABASE_SERVICE_ROLE_KEY` | Supabase service role key | `eyJ...` |
| `MINIO_ENDPOINT_HOST` | MinIO host | `minio` (Docker) / `localhost` |
| `MINIO_ENDPOINT_PORT` | MinIO port | `9000` |
| `MINIO_USE_SSL` | Use SSL | `false` |
| `MINIO_ACCESS_KEY` | MinIO access key | Custom strong password |
| `MINIO_SECRET_KEY` | MinIO secret key | Custom strong password (â‰¥8 chars) |
| `MINIO_BUCKET` | Bucket name | `pis-photos` |
| `REDIS_HOST` | Redis host | `redis` (Docker) / `localhost` |
| `REDIS_PORT` | Redis port | `6379` |

---

## Verification & Testing

### 1. Check Docker Services

```bash
# Check service status
docker-compose ps

# Expected output:
# NAME            STATUS
# pis-minio       Up (healthy)
# pis-redis       Up (healthy)
# pis-worker      Up

# MinIO health check
curl http://localhost:9000/minio/health/live
# Expected: OK

# Redis connection test
docker exec pis-redis redis-cli ping
# Expected: PONG
```

### 2. Test Complete Flow

1. Visit `https://yourdomain.com/admin/login`
2. Log in with admin account
3. Create new album
4. Upload test image
5. Observe Worker logs: `docker-compose logs -f worker`
6. Confirm image processing completed (status becomes completed)
7. Copy album link, test guest access in incognito mode

### 3. Performance Check

```bash
# Lighthouse test
npx lighthouse https://yourdomain.com --view

# Target metrics:
# - FCP < 1.5s
# - LCP < 2.5s
# - Score > 90
```

---

## Maintenance & Operations

### Common Commands

```bash
# View logs
docker-compose logs -f [service]

# Restart service
docker-compose restart [service]

# Update Worker code
docker-compose build worker
docker-compose up -d worker

# Clean unused images
docker system prune -a
```

### Data Backup

```bash
# Backup MinIO data
docker run --rm \
  -v pis_minio_data:/data \
  -v $(pwd):/backup \
  alpine tar czf /backup/minio-backup-$(date +%Y%m%d).tar.gz /data

# Restore MinIO data
docker run --rm \
  -v pis_minio_data:/data \
  -v $(pwd):/backup \
  alpine tar xzf /backup/minio-backup.tar.gz -C /

# Supabase data export
# In Dashboard â†’ Settings â†’ Database â†’ Backups
```

### Monitoring Recommendations

- **Uptime Kuma**: Monitor service availability
- **Grafana + Prometheus**: Docker container monitoring
- **Sentry**: Frontend error tracking

---

## Troubleshooting

### Worker Cannot Connect to MinIO

```bash
# Check Docker network
docker network ls
docker-compose exec worker ping minio

# Confirm MinIO environment variables
docker-compose exec worker env | grep MINIO
```

### Images Cannot Display

1. Check if MinIO Bucket exists and has permissions
   ```bash
   docker exec pis-minio mc ls local/pis-photos
   ```
2. Check Nginx reverse proxy logs
   ```bash
   tail -f /var/log/nginx/error.log
   ```
3. Verify `NEXT_PUBLIC_MEDIA_URL` is configured correctly

### Supabase Connection Failed

1. Verify API Keys are correct (note anon vs service_role)
2. Check if RLS policies are blocking access
3. View Supabase Dashboard â†’ Logs

### Upload Failed

1. Check Nginx `client_max_body_size` configuration
2. Verify MinIO credentials are correct
3. View Worker logs:
   ```bash
   docker-compose logs -f worker
   ```

### Login Loop Issue

1. Clear browser Cookies (all starting with `sb-`)
2. Verify Supabase Auth URLs configuration is correct
3. Check Middleware logs

---

## Security Recommendations

### Must Do

- [ ] Change default MinIO password
- [ ] Use HTTPS
- [ ] Service ports only listen on 127.0.0.1
- [ ] Regular data backups
- [ ] Protect `SUPABASE_SERVICE_ROLE_KEY`

### Recommended

- [ ] Configure firewall rules
- [ ] Enable Supabase MFA
- [ ] Set up log rotation
- [ ] Configure monitoring alerts

---

## Support

If you encounter issues:

1. Check the troubleshooting section in this document
2. Search GitHub Issues
3. Submit a new Issue with:
   - Error logs
   - Environment information (OS, Docker version)
   - Reproduction steps
