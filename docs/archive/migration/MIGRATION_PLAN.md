# PIS Standalone æ”¹é€ è®¡åˆ’

> âš ï¸ **æ­¤æ–‡æ¡£ä¸ºå†å²æ–‡æ¡£** - è¿ç§»å·¥ä½œå·²å®Œæˆ

> ä» pis-cloudï¼ˆVercel + Supabaseï¼‰è¿ç§»åˆ° pis-standaloneï¼ˆå®Œå…¨è‡ªæ‰˜ç®¡ï¼‰

## âœ… è¿ç§»çŠ¶æ€ï¼šå·²å®Œæˆ

æ‰€æœ‰è¿ç§»å·¥ä½œå·²å®Œæˆï¼è¯·å‚è€ƒä»¥ä¸‹æ–‡æ¡£è·å–æœ€æ–°ä¿¡æ¯ï¼š

- **[è¿ç§»å®Œæˆæ€»ç»“](./MIGRATION_COMPLETE.md)** - è¯¦ç»†çš„è¿ç§»å®ŒæˆæŠ¥å‘Š
- **[è¿ç§»æœ€ç»ˆæ€»ç»“](./MIGRATION_FINAL_SUMMARY.md)** - å®Œæ•´çš„è¿ç§»ç»Ÿè®¡å’Œæ€»ç»“
- **[ä¸‹ä¸€æ­¥æ“ä½œ](./NEXT_STEPS.md)** - è¿ç§»åçš„æ“ä½œæŒ‡å—
- **[è¿ç§»çŠ¶æ€](./MIGRATION_STATUS.md)** - å½“å‰è¿ç§»çŠ¶æ€å’Œå¯é€‰ä»»åŠ¡

---

## ğŸ“‹ å†å²çŠ¶æ€ï¼ˆå·²è¿‡æ—¶ï¼‰

### âœ… å·²å®Œæˆ
- Worker ç«¯å·²æ”¯æŒ PostgreSQLï¼ˆ`services/worker/src/lib/database/postgresql-adapter.ts`ï¼‰
- è‡ªå®šä¹‰è®¤è¯ç³»ç»ŸåŸºç¡€ä»£ç å·²å­˜åœ¨ï¼ˆ`apps/web/src/lib/auth/index.ts`ï¼‰
- æ–‡æ¡£å’Œé“¾æ¥å·²æ›´æ–°
- âœ… **æ‰€æœ‰å‰ç«¯ä»£ç å·²è¿ç§»åˆ° PostgreSQL**
- âœ… **è®¤è¯ç³»ç»Ÿå·²å®Œå…¨é›†æˆ**
- âœ… **æ•°æ®åº“å®¢æˆ·ç«¯å·²åˆ›å»ºå¹¶æŠ•å…¥ä½¿ç”¨**

### âŒ ~~å¾…æ”¹é€ ~~ï¼ˆå·²å®Œæˆï¼‰
- ~~å‰ç«¯ä»å¤§é‡ä½¿ç”¨ Supabase~~ âœ… å·²å®Œæˆ
- ~~è®¤è¯ç³»ç»Ÿæœªå®Œå…¨é›†æˆ~~ âœ… å·²å®Œæˆ
- ~~æ•°æ®åº“å®¢æˆ·ç«¯æœªåˆ›å»º~~ âœ… å·²å®Œæˆ

---

## ğŸ¯ æ”¹é€ ä»»åŠ¡æ¸…å•

### é˜¶æ®µ 1: æ•°æ®åº“å®¢æˆ·ç«¯ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

#### 1.1 åˆ›å»º PostgreSQL å®¢æˆ·ç«¯åº“
- [ ] åˆ›å»º `apps/web/src/lib/database/postgresql-client.ts`
  - æä¾›ä¸ Supabase å®¢æˆ·ç«¯ç±»ä¼¼çš„ API
  - æ”¯æŒ Server Components å’Œ API Routes
  - ä½¿ç”¨è¿æ¥æ± ç®¡ç†æ•°æ®åº“è¿æ¥

#### 1.2 åˆ›å»ºæ•°æ®åº“é€‚é…å™¨å·¥å‚
- [ ] åˆ›å»º `apps/web/src/lib/database/index.ts`
  - æ ¹æ® `DATABASE_TYPE` ç¯å¢ƒå˜é‡é€‰æ‹©é€‚é…å™¨
  - æ”¯æŒ PostgreSQL å’Œ Supabaseï¼ˆå‘åå…¼å®¹ï¼‰

#### 1.3 æ›¿æ¢ Supabase å®¢æˆ·ç«¯è°ƒç”¨
- [ ] æ›´æ–° `apps/web/src/lib/supabase/server.ts` â†’ ä½¿ç”¨ PostgreSQL å®¢æˆ·ç«¯
- [ ] æ›´æ–° `apps/web/src/lib/supabase/admin.ts` â†’ ä½¿ç”¨ PostgreSQL å®¢æˆ·ç«¯
- [ ] åˆ›å»ºå…¼å®¹å±‚ï¼Œä¿æŒ API ä¸€è‡´æ€§

---

### é˜¶æ®µ 2: è®¤è¯ç³»ç»Ÿé›†æˆï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

#### 2.1 å®Œæˆç™»å½• API æ”¹é€ 
- [ ] æ›´æ–° `apps/web/src/app/api/auth/login/route.ts`
  - ç§»é™¤ Supabase Auth è°ƒç”¨
  - ä½¿ç”¨è‡ªå®šä¹‰è®¤è¯ç³»ç»Ÿï¼ˆ`lib/auth/index.ts`ï¼‰
  - è¿æ¥ PostgreSQL éªŒè¯ç”¨æˆ·å¯†ç 

#### 2.2 å®Œæˆç™»å‡º API æ”¹é€ 
- [ ] æ›´æ–° `apps/web/src/app/api/auth/signout/route.ts`
  - ä½¿ç”¨è‡ªå®šä¹‰è®¤è¯ç³»ç»Ÿçš„ `destroySession()`

#### 2.3 æ›´æ–°è®¤è¯ä¸­é—´ä»¶
- [ ] æ›´æ–° `apps/web/src/middleware.ts`
  - ç§»é™¤ Supabase `updateSession`
  - ä½¿ç”¨è‡ªå®šä¹‰è®¤è¯çš„ `updateSessionMiddleware`

#### 2.4 æ›´æ–°è®¤è¯ Hooks
- [ ] æ›´æ–° `apps/web/src/hooks/use-auth.ts`
  - ç§»é™¤ Supabase å®¢æˆ·ç«¯
  - ä½¿ç”¨ `/api/auth/me` ç«¯ç‚¹è·å–ç”¨æˆ·ä¿¡æ¯
  - å®ç°å®¢æˆ·ç«¯ä¼šè¯ç®¡ç†

---

### é˜¶æ®µ 3: API è·¯ç”±æ”¹é€ ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰

#### 3.1 ç®¡ç†å‘˜ API è·¯ç”±
éœ€è¦æ›´æ–°çš„è·¯ç”±ï¼ˆçº¦ 40+ ä¸ªæ–‡ä»¶ï¼‰ï¼š
- [ ] `apps/web/src/app/api/admin/**/*.ts`
  - æ›¿æ¢ `createClient()` â†’ PostgreSQL å®¢æˆ·ç«¯
  - æ›¿æ¢ `createAdminClient()` â†’ PostgreSQL Admin å®¢æˆ·ç«¯

#### 3.2 å…¬å¼€ API è·¯ç”±
- [ ] `apps/web/src/app/api/public/**/*.ts`
  - æ›¿æ¢æ•°æ®åº“æŸ¥è¯¢è°ƒç”¨

---

### é˜¶æ®µ 4: ç»„ä»¶æ”¹é€ ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰

#### 4.1 é¡µé¢ç»„ä»¶
- [ ] `apps/web/src/app/admin/**/*.tsx`
  - æ›´æ–°æ•°æ®è·å–é€»è¾‘
  - ä½¿ç”¨æ–°çš„æ•°æ®åº“å®¢æˆ·ç«¯

#### 4.2 å…¬å…±ç»„ä»¶
- [ ] `apps/web/src/app/album/**/*.tsx`
  - æ›´æ–°æ•°æ®æŸ¥è¯¢

---

### é˜¶æ®µ 5: é…ç½®å’Œç¯å¢ƒå˜é‡ï¼ˆä¼˜å…ˆçº§ï¼šä½ï¼‰

#### 5.1 ç¯å¢ƒå˜é‡
- [ ] æ›´æ–° `.env.example`
  - ç§»é™¤ `NEXT_PUBLIC_SUPABASE_*` å˜é‡
  - æ·»åŠ  PostgreSQL è¿æ¥å˜é‡
  - æ·»åŠ è®¤è¯ç›¸å…³å˜é‡

#### 5.2 éƒ¨ç½²è„šæœ¬
- [ ] æ›´æ–° `scripts/deploy.sh`
  - é»˜è®¤ä½¿ç”¨ PostgreSQL
  - ç§»é™¤ Supabase é…ç½®æ­¥éª¤

#### 5.3 æ–‡æ¡£æ›´æ–°
- [ ] æ›´æ–°éƒ¨ç½²æ–‡æ¡£
- [ ] æ›´æ–°ç¯å¢ƒå˜é‡æ–‡æ¡£

---

### é˜¶æ®µ 6: æµ‹è¯•å’Œæ¸…ç†ï¼ˆä¼˜å…ˆçº§ï¼šä½ï¼‰

#### 6.1 æµ‹è¯•æ›´æ–°
- [ ] æ›´æ–°æ‰€æœ‰æµ‹è¯•æ–‡ä»¶
  - ç§»é™¤ Supabase ç›¸å…³æµ‹è¯•
  - æ·»åŠ  PostgreSQL æµ‹è¯•

#### 6.2 ä»£ç æ¸…ç†
- [ ] ç§»é™¤æœªä½¿ç”¨çš„ Supabase ä¾èµ–ï¼ˆå¯é€‰ï¼Œä¿ç•™å…¼å®¹æ€§ï¼‰
- [ ] æ¸…ç†æ³¨é‡Šå’Œæ–‡æ¡£

---

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### PostgreSQL å®¢æˆ·ç«¯è®¾è®¡

```typescript
// apps/web/src/lib/database/postgresql-client.ts
import { Pool } from 'pg'

export class PostgreSQLClient {
  private pool: Pool
  
  constructor() {
    this.pool = new Pool({
      connectionString: process.env.DATABASE_URL,
      // ... é…ç½®
    })
  }
  
  // æä¾›ç±»ä¼¼ Supabase çš„ API
  from<T>(table: string): QueryBuilder<T> {
    return new QueryBuilder<T>(this.pool, table)
  }
  
  // Admin å®¢æˆ·ç«¯ï¼ˆç»•è¿‡æƒé™æ£€æŸ¥ï¼‰
  admin(): PostgreSQLClient {
    return this
  }
}
```

### è®¤è¯æµç¨‹

1. **ç™»å½•**ï¼š
   - ç”¨æˆ·æäº¤é‚®ç®±å’Œå¯†ç 
   - æœåŠ¡ç«¯æŸ¥è¯¢ PostgreSQL `users` è¡¨
   - éªŒè¯å¯†ç å“ˆå¸Œ
   - ç”Ÿæˆ JWT Token
   - è®¾ç½® HttpOnly Cookie

2. **ä¼šè¯éªŒè¯**ï¼š
   - Middleware è¯»å– Cookie
   - éªŒè¯ JWT Token
   - åˆ·æ–°å³å°†è¿‡æœŸçš„ Token

3. **ç™»å‡º**ï¼š
   - æ¸…é™¤ Cookie
   - å¯é€‰ï¼šå°† Token åŠ å…¥é»‘åå•

---

## ğŸ“Š å½±å“èŒƒå›´ç»Ÿè®¡

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

| ç±»å‹ | æ•°é‡ | ä¼˜å…ˆçº§ |
|------|------|--------|
| æ•°æ®åº“å®¢æˆ·ç«¯åº“ | ~5 | é«˜ |
| è®¤è¯ç›¸å…³ | ~10 | é«˜ |
| API è·¯ç”± | ~40+ | ä¸­ |
| é¡µé¢ç»„ä»¶ | ~20+ | ä¸­ |
| é…ç½®å’Œè„šæœ¬ | ~5 | ä½ |
| æµ‹è¯•æ–‡ä»¶ | ~30+ | ä½ |

**æ€»è®¡**: ~110+ ä¸ªæ–‡ä»¶éœ€è¦ä¿®æ”¹

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹æ€§**ï¼š
   - ä¿ç•™ Supabase é€‚é…å™¨ä»£ç ï¼ˆå¯é€‰ï¼‰
   - é€šè¿‡ç¯å¢ƒå˜é‡åˆ‡æ¢æ•°æ®åº“ç±»å‹

2. **æ•°æ®åº“è¿ç§»**ï¼š
   - ç¡®ä¿ PostgreSQL æ•°æ®åº“ç»“æ„ä¸ Supabase ä¸€è‡´
   - ç”¨æˆ·è¡¨éœ€è¦åŒ…å« `password_hash` å­—æ®µ

3. **ä¼šè¯ç®¡ç†**ï¼š
   - JWT Token å­˜å‚¨åœ¨ HttpOnly Cookie ä¸­
   - åˆ·æ–° Token æœºåˆ¶éœ€è¦å®ç°

4. **æµ‹è¯•**ï¼š
   - æ¯ä¸ªé˜¶æ®µå®Œæˆåè¿›è¡Œæµ‹è¯•
   - ç¡®ä¿åŠŸèƒ½å®Œæ•´æ€§

---

## ğŸš€ å¼€å§‹æ”¹é€ 

å»ºè®®æŒ‰é˜¶æ®µé€æ­¥è¿›è¡Œï¼Œæ¯ä¸ªé˜¶æ®µå®Œæˆåè¿›è¡Œæµ‹è¯•å’ŒéªŒè¯ã€‚

**ç¬¬ä¸€æ­¥**ï¼šåˆ›å»º PostgreSQL å®¢æˆ·ç«¯åº“å’Œæ•°æ®åº“é€‚é…å™¨å·¥å‚ã€‚
