name: pis

# ============================================
# PIS 完全自托管部署配置（生产环境）
#
# 包含服务：
# - PostgreSQL: 数据库（端口 5432）
# - MinIO: 对象存储（端口 9000/9001）
# - Redis: 任务队列/缓存（端口 6379）
# - Web: Next.js 前端（端口 8081）
# - Worker: 图片处理服务（端口 3001）
#
# 端口说明（多端口模式）：
# - 8081: Web (Next.js 前端)
# - 5432: PostgreSQL 数据库
# - 9000: MinIO API
# - 9001: MinIO Console
# - 6379: Redis
# - 3001: Worker API
#
# 所有服务端口直接暴露，便于访问和管理
# ============================================

networks:
  pis-network:
    driver: bridge
    name: pis-network

volumes:
  pis_postgres_data:
    name: pis_postgres_data
  pis_minio_data:
    name: pis_minio_data
  pis_redis_data:
    name: pis_redis_data
  pis_worker_logs:
    name: pis_worker_logs
  pis_web_logs:
    name: pis_web_logs
  pis_ai_models:
    name: pis_ai_models

services:
  # ==================== 数据库 ====================
  postgres:
    image: pgvector/pgvector:pg16
    pull_policy: if_not_present  # 优先使用本地镜像，不存在时才拉取
    container_name: pis-postgres
    env_file:
      - ../.env
    environment:
      # PostgreSQL 默认配置（可被 .env 覆盖）
      POSTGRES_DB: ${POSTGRES_DB:-pis}
      POSTGRES_USER: ${POSTGRES_USER:-pis}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD:-changeme}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - pis_postgres_data:/var/lib/postgresql/data
      # 数据库初始化脚本（PostgreSQL 容器会在首次启动时按文件名排序执行）
      # 执行顺序：init-postgresql-db.sql -> init-postgresql.sh
      - ./init-postgresql-db.sql:/docker-entrypoint-initdb.d/init-postgresql-db.sql:ro
      - ./init-postgresql.sh:/docker-entrypoint-initdb.d/init-postgresql.sh:ro
    # ports:
    #   - "5432:5432"  # PostgreSQL 数据库端口 (仅内部访问)
    restart: unless-stopped
    networks:
      - pis-network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${POSTGRES_USER:-pis} -d ${POSTGRES_DB:-pis}",
        ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==================== 对象存储 ====================
  minio:
    image: minio/minio:RELEASE.2025-04-22T22-12-26Z
    pull_policy: if_not_present  # 优先使用本地镜像，不存在时才拉取
    container_name: pis-minio
    env_file:
      - ../.env
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:-minioadmin}
      # MinIO Console 访问路径
      MINIO_BROWSER_REDIRECT_URL: ${NEXT_PUBLIC_APP_URL:-http://${DOMAIN:-localhost}:8088}/minio-console
    volumes:
      - pis_minio_data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # MinIO Bucket 初始化
  # 注意：Worker 启动时会自动检查并创建 bucket，此容器作为备用初始化
  minio-init:
    image: minio/mc:latest
    pull_policy: if_not_present  # 优先使用本地镜像，不存在时才拉取
    container_name: pis-minio-init
    env_file:
      - ../.env
    depends_on:
      minio:
        condition: service_healthy
    networks:
      - pis-network
    environment:
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
    entrypoint: >
      /bin/sh -c "
      sleep 5;
      mc alias set pis http://pis-minio:9000 $${MINIO_ACCESS_KEY} $${MINIO_SECRET_KEY};
      mc mb pis/pis-photos --ignore-existing || true;
      # 设置访问策略（注意：在对象存储中，raw/ 和 processed/ 是前缀，不是真正的目录）
      # 只公开 processed 前缀的文件（缩略图和预览图可以公开访问）
      mc anonymous set download pis/pis-photos/processed/ || true;
      # raw 前缀的文件（原图）需要通过应用控制访问
      mc anonymous set off pis/pis-photos/raw/ || true;
      echo 'MinIO bucket initialized with access policies';
      exit 0;
      "
    restart: "no" # 只运行一次，Worker 会负责确保 bucket 存在

  # ==================== 任务队列 ====================
  redis:
    image: redis:7-alpine
    pull_policy: if_not_present  # 优先使用本地镜像，不存在时才拉取
    container_name: pis-redis
    volumes:
      - pis_redis_data:/data
    command: redis-server --appendonly yes
    # ports:
    #   - "6379:6379"  # Redis 端口 (仅内部访问)
    restart: unless-stopped
    networks:
      - pis-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==================== 图片处理 Worker ====================
  worker:
    build:
      context: ..
      dockerfile: docker/worker.Dockerfile
    container_name: pis-worker
    env_file:
      - ../.env
    environment:
      # 数据库连接模式（standalone 模式使用 PostgreSQL）
      - DATABASE_TYPE=${DATABASE_TYPE:-postgresql}
      # PostgreSQL 直连配置
      # 注意：DATABASE_PASSWORD 和 POSTGRES_PASSWORD 从 env_file (../.env) 读取
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_NAME=${POSTGRES_DB:-pis}
      - DATABASE_USER=${POSTGRES_USER:-pis}
      # DATABASE_PASSWORD 从 env_file 读取，不需要在这里设置
      # MinIO
      - MINIO_ENDPOINT_HOST=pis-minio
      - MINIO_ENDPOINT_PORT=9000
      - MINIO_USE_SSL=false
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-minioadmin}
      - MINIO_BUCKET=${MINIO_BUCKET:-pis-photos}
      # Storage 配置
      - STORAGE_TYPE=minio
      - STORAGE_ENDPOINT=pis-minio
      - STORAGE_PORT=9000
      - STORAGE_USE_SSL=false
      - STORAGE_ACCESS_KEY=${MINIO_ACCESS_KEY:-minioadmin}
      - STORAGE_SECRET_KEY=${MINIO_SECRET_KEY:-minioadmin}
      - STORAGE_BUCKET=${MINIO_BUCKET:-pis-photos}
      # Redis
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # Worker 配置
      - NODE_ENV=production
      - HTTP_PORT=3001
      - WORKER_API_KEY=${WORKER_API_KEY:-changeme}
      # 存储公网 URL
      - STORAGE_PUBLIC_URL=${STORAGE_PUBLIC_URL:-http://${DOMAIN:-localhost}:9000}
      - MINIO_PUBLIC_URL=${MINIO_PUBLIC_URL:-http://${DOMAIN:-localhost}:8088/media}
      # 告警配置
      - ALERT_ENABLED=${ALERT_ENABLED:-true}
      - ALERT_TYPE=${ALERT_TYPE:-log}
      # FTP 配置
      - FTP_USER=${FTP_USER:-pis}
      - FTP_PASSWORD=${FTP_PASSWORD:-pis}
      - FTP_PORT=21
      - FTP_PASV_START=30000
      - FTP_PASV_END=30009
      - FTP_PASV_URL=${FTP_PASV_URL:-} # 留空则自动检测
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "21:21"             # FTP 命令端口
      - "30000-30009:30000-30009" # FTP 被动模式端口范围
    restart: unless-stopped
    networks:
      - pis-network
    healthcheck:
      test: ["CMD", "node", "-e", "console.log('healthy')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==================== Next.js 前端 ====================
  web:
    build:
      context: ..
      dockerfile: docker/web.Dockerfile
      args:
        NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL:-https://${DOMAIN:-localhost}}
        NEXT_PUBLIC_MEDIA_URL: ${NEXT_PUBLIC_MEDIA_URL:-https://${DOMAIN:-localhost}/media}
        NEXT_PUBLIC_PHOTOGRAPHER_NAME: ${NEXT_PUBLIC_PHOTOGRAPHER_NAME:-PIS Photography}
        NEXT_PUBLIC_PHOTOGRAPHER_TAGLINE: ${NEXT_PUBLIC_PHOTOGRAPHER_TAGLINE:-专业活动摄影}
        # 轮询配置（standalone 模式使用轮询实现实时更新）
        NEXT_PUBLIC_POLLING_INTERVAL: ${NEXT_PUBLIC_POLLING_INTERVAL:-3000}
        NEXT_PUBLIC_ADMIN_POLLING_INTERVAL: ${NEXT_PUBLIC_ADMIN_POLLING_INTERVAL:-2000}
    container_name: pis-web
    env_file:
      - ../.env
    environment:
      # 认证模式（standalone 模式使用自定义认证）
      - AUTH_MODE=${AUTH_MODE:-custom}
      - AUTH_JWT_SECRET=${AUTH_JWT_SECRET}
      # 数据库连接（standalone 模式使用 PostgreSQL）
      # 注意：DATABASE_PASSWORD 和 POSTGRES_PASSWORD 从 env_file (../.env) 读取
      - DATABASE_TYPE=${DATABASE_TYPE:-postgresql}
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_NAME=${POSTGRES_DB:-pis}
      - DATABASE_USER=${POSTGRES_USER:-pis}
      # DATABASE_PASSWORD 从 env_file 读取，不需要在这里设置
      # 应用配置
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL:-http://${DOMAIN:-localhost}:8080}
      - NEXT_PUBLIC_MEDIA_URL=${NEXT_PUBLIC_MEDIA_URL:-http://${DOMAIN:-localhost}:8080/media}
      - NEXT_PUBLIC_PHOTOGRAPHER_NAME=${NEXT_PUBLIC_PHOTOGRAPHER_NAME:-PIS Photography}
      - NEXT_PUBLIC_PHOTOGRAPHER_TAGLINE=${NEXT_PUBLIC_PHOTOGRAPHER_TAGLINE:-专业活动摄影}
      # Worker API
      - WORKER_URL=http://pis-worker:3001
      - NEXT_PUBLIC_WORKER_URL=${NEXT_PUBLIC_WORKER_URL:-http://${DOMAIN:-localhost}:8080/worker-api}
      - WORKER_API_KEY=${WORKER_API_KEY:-changeme}
      # MinIO 配置（用于媒体文件和 MinIO Console 代理）
      - MINIO_ENDPOINT_HOST=pis-minio
      - MINIO_ENDPOINT_PORT=9000
      - MINIO_CONSOLE_PORT=9001
      - MINIO_USE_SSL=false
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-minioadmin}
      - MINIO_BUCKET=${MINIO_BUCKET:-pis-photos}
      # 会话密钥（必须设置）
      - ALBUM_SESSION_SECRET=${ALBUM_SESSION_SECRET}
      # 轮询配置（standalone 模式使用轮询实现实时更新）
      - NEXT_PUBLIC_POLLING_INTERVAL=${NEXT_PUBLIC_POLLING_INTERVAL:-3000}
      - NEXT_PUBLIC_ADMIN_POLLING_INTERVAL=${NEXT_PUBLIC_ADMIN_POLLING_INTERVAL:-2000}
      # 日志配置
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - ENABLE_PRETTY_LOG=${ENABLE_PRETTY_LOG:-false}
    volumes:
      - pis_web_logs:/app/logs
    # ports:
    #   - "8081:3000" # Web 前端端口 (由 Nginx 代理)
    depends_on:
      postgres:
        condition: service_healthy
      worker:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - pis-network
    healthcheck:
      # 使用 curl（Alpine 镜像默认包含，无需安装）
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ==================== AI 服务 ====================
  ai:
    build:
      context: ../services/ai
      dockerfile: Dockerfile
    container_name: pis-ai
    ports:
      - "8000:8000"
    volumes:
      - pis_ai_models:/root/.insightface/models
    networks:
      - pis-network
    restart: unless-stopped

  # ==================== Nginx ====================
  nginx:
    image: nginx:alpine
    pull_policy: if_not_present  # 优先使用本地镜像，不存在时才拉取
    container_name: pis-nginx
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    ports:
      - "8088:80"
    depends_on:
      web:
        condition: service_healthy
      minio:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - pis-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/nginx-health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
