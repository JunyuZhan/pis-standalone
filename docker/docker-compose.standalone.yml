name: pis

# ============================================
# PIS 完全自托管部署配置
#
# 包含服务：
# - PostgreSQL: 数据库
# - MinIO: 对象存储
# - Redis: 任务队列/缓存
# - Web: Next.js 前端（集成代理功能）
# - Worker: 图片处理服务
#
# 端口说明：
# - 8081: Web (Next.js 前端，唯一对外暴露端口)
#   所有服务都通过 Next.js 的路径访问，不直接暴露端口：
#   - / : Next.js 前端应用
#   - /api/ : Next.js API
#   - /media/* : MinIO 媒体文件（通过 Next.js API Route 代理到 pis-minio:9000）
#   - /minio-console/* : MinIO 管理控制台（通过 Next.js API Route 代理到 pis-minio:9001）
#   - /api/worker/* : Worker API（通过 Next.js API Route 代理到 pis-worker:3001）
#   - /health : 健康检查
#
# 其他容器（PostgreSQL、MinIO、Redis、Worker）：
# - ❌ 不暴露端口，仅 Docker 内部网络访问
# - ✅ 通过 Next.js Web 容器的路径统一访问
# ============================================

networks:
  pis-network:
    driver: bridge
    name: pis-network

volumes:
  pis_postgres_data:
    name: pis_postgres_data
  pis_minio_data:
    name: pis_minio_data
  pis_redis_data:
    name: pis_redis_data
  pis_worker_logs:
    name: pis_worker_logs
  pis_web_logs:
    name: pis_web_logs

services:
  # ==================== 数据库 ====================
  postgres:
    image: postgres:16-alpine
    container_name: pis-postgres
    env_file:
      - ../.env
    environment:
      # PostgreSQL 默认配置（可被 .env 覆盖）
      POSTGRES_DB: ${POSTGRES_DB:-pis}
      POSTGRES_USER: ${POSTGRES_USER:-pis}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - pis_postgres_data:/var/lib/postgresql/data
      # 数据库初始化脚本（按执行顺序）
      - ./init-postgresql-db.sql:/docker-entrypoint-initdb.d/init-postgresql-db.sql:ro
      - ./init-postgresql.sh:/docker-entrypoint-initdb.d/init-postgresql.sh:ro
    # 不暴露端口，仅容器内访问（通过 Next.js Web 容器路径访问）
    restart: unless-stopped
    networks:
      - pis-network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${POSTGRES_USER:-pis} -d ${POSTGRES_DB:-pis}",
        ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==================== 对象存储 ====================
  minio:
    image: minio/minio:RELEASE.2025-04-22T22-12-26Z
    container_name: pis-minio
    env_file:
      - ../.env
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:-minioadmin}
    volumes:
      - pis_minio_data:/data
    command: server /data --console-address ":9001"
    # 暴露端口用于直接上传（presigned URL 需要直接访问 MinIO）
    # 19001: MinIO Console（用于浏览器登录上传，避免公网 API 暴露）
    ports:
      # - "19000:9000"  # 不暴露 MinIO API（不使用 presigned URL）
      - "19001:9001" # MinIO Console（用于浏览器登录上传）
    restart: unless-stopped
    networks:
      - pis-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # MinIO Bucket 初始化
  # 注意：Worker 启动时会自动检查并创建 bucket，此容器作为备用初始化
  minio-init:
    image: minio/mc:latest
    container_name: pis-minio-init
    env_file:
      - ../.env
    depends_on:
      minio:
        condition: service_healthy
    networks:
      - pis-network
    environment:
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
    entrypoint: >
      /bin/sh -c "
      sleep 5;
      mc alias set pis http://minio:9000 $${MINIO_ACCESS_KEY} $${MINIO_SECRET_KEY};
      mc mb pis/pis-photos --ignore-existing || true;
      # 设置访问策略（注意：在对象存储中，raw/ 和 processed/ 是前缀，不是真正的目录）
      # 只公开 processed 前缀的文件（缩略图和预览图可以公开访问）
      mc anonymous set download pis/pis-photos/processed/ || true;
      # raw 前缀的文件（原图）需要通过应用控制访问
      mc anonymous set off pis/pis-photos/raw/ || true;
      echo 'MinIO bucket initialized with access policies';
      exit 0;
      "
    restart: "no" # 只运行一次，Worker 会负责确保 bucket 存在

  # ==================== 任务队列 ====================
  redis:
    image: redis:7-alpine
    container_name: pis-redis
    volumes:
      - pis_redis_data:/data
    command: redis-server --appendonly yes
    # 不暴露端口，仅容器内访问
    restart: unless-stopped
    networks:
      - pis-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==================== 图片处理 Worker ====================
  worker:
    build:
      context: ..
      dockerfile: docker/worker.Dockerfile
    container_name: pis-worker
    env_file:
      - ../.env
    environment:
      # 数据库连接模式（standalone 模式使用 PostgreSQL）
      - DATABASE_TYPE=${DATABASE_TYPE:-postgresql}
      # PostgreSQL 直连配置
      # 注意：DATABASE_PASSWORD 和 POSTGRES_PASSWORD 从 env_file (../.env) 读取
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_NAME=${POSTGRES_DB:-pis}
      - DATABASE_USER=${POSTGRES_USER:-pis}
      # DATABASE_PASSWORD 从 env_file 读取，不需要在这里设置
      # MinIO
      - MINIO_ENDPOINT_HOST=minio
      - MINIO_ENDPOINT_PORT=9000
      - MINIO_USE_SSL=false
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-minioadmin}
      - MINIO_BUCKET=${MINIO_BUCKET:-pis-photos}
      # Storage 配置
      - STORAGE_TYPE=minio
      - STORAGE_ENDPOINT=minio
      - STORAGE_PORT=9000
      - STORAGE_USE_SSL=false
      - STORAGE_ACCESS_KEY=${MINIO_ACCESS_KEY:-minioadmin}
      - STORAGE_SECRET_KEY=${MINIO_SECRET_KEY:-minioadmin}
      - STORAGE_BUCKET=${MINIO_BUCKET:-pis-photos}
      # Redis
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # Worker 配置
      - NODE_ENV=production
      - HTTP_PORT=3001
      - WORKER_API_KEY=${WORKER_API_KEY:-changeme}
      # 存储公网 URL
      # STORAGE_PUBLIC_URL: 用于读取文件（通过 Next.js 代理）
      # 注意：env_file 中的值会被 environment 中的值覆盖
      # 如果 .env 文件中设置了 STORAGE_PUBLIC_URL，则使用该值；否则使用默认值
      - STORAGE_PUBLIC_URL=${STORAGE_PUBLIC_URL:-https://${DOMAIN:-localhost}/media}
      # MINIO_PUBLIC_URL: 在 standalone 模式下，应使用与 STORAGE_PUBLIC_URL 相同的值（通过 /media/ 代理）
      # 注意：presigned URL 实际上不能通过代理使用，但这里设置为相同值以避免 CSP 错误
      # 实际上，上传应该通过 Next.js API 代理，而不是直接使用 presigned URL
      # 如果 .env 文件中设置了 MINIO_PUBLIC_URL，则使用该值；否则使用 STORAGE_PUBLIC_URL 或默认值
      - MINIO_PUBLIC_URL=${MINIO_PUBLIC_URL:-${STORAGE_PUBLIC_URL:-https://${DOMAIN:-localhost}/media}}
      # 告警配置
      - ALERT_ENABLED=${ALERT_ENABLED:-true}
      - ALERT_TYPE=${ALERT_TYPE:-log}
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - pis-network
    healthcheck:
      test: ["CMD", "node", "-e", "console.log('healthy')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==================== Next.js 前端 ====================
  web:
    build:
      context: ..
      dockerfile: docker/web.Dockerfile
      args:
        NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL:-https://${DOMAIN:-localhost}}
        NEXT_PUBLIC_MEDIA_URL: ${NEXT_PUBLIC_MEDIA_URL:-https://${DOMAIN:-localhost}/media}
        NEXT_PUBLIC_PHOTOGRAPHER_NAME: ${NEXT_PUBLIC_PHOTOGRAPHER_NAME:-PIS Photography}
        NEXT_PUBLIC_PHOTOGRAPHER_TAGLINE: ${NEXT_PUBLIC_PHOTOGRAPHER_TAGLINE:-专业活动摄影}
        # 轮询配置（standalone 模式使用轮询实现实时更新）
        NEXT_PUBLIC_POLLING_INTERVAL: ${NEXT_PUBLIC_POLLING_INTERVAL:-3000}
        NEXT_PUBLIC_ADMIN_POLLING_INTERVAL: ${NEXT_PUBLIC_ADMIN_POLLING_INTERVAL:-2000}
    container_name: pis-web
    env_file:
      - ../.env
    environment:
      # 认证模式（standalone 模式使用自定义认证）
      - AUTH_MODE=${AUTH_MODE:-custom}
      - AUTH_JWT_SECRET=${AUTH_JWT_SECRET}
      # 数据库连接（standalone 模式使用 PostgreSQL）
      # 注意：DATABASE_PASSWORD 和 POSTGRES_PASSWORD 从 env_file (../.env) 读取
      - DATABASE_TYPE=${DATABASE_TYPE:-postgresql}
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_NAME=${POSTGRES_DB:-pis}
      - DATABASE_USER=${POSTGRES_USER:-pis}
      # DATABASE_PASSWORD 从 env_file 读取，不需要在这里设置
      # 应用配置
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL:-https://${DOMAIN:-localhost}}
      - NEXT_PUBLIC_MEDIA_URL=${NEXT_PUBLIC_MEDIA_URL:-https://${DOMAIN:-localhost}/media}
      - NEXT_PUBLIC_PHOTOGRAPHER_NAME=${NEXT_PUBLIC_PHOTOGRAPHER_NAME:-PIS Photography}
      - NEXT_PUBLIC_PHOTOGRAPHER_TAGLINE=${NEXT_PUBLIC_PHOTOGRAPHER_TAGLINE:-专业活动摄影}
      # Worker API（Docker 内部网络使用服务名）
      - WORKER_URL=http://worker:3001
      - NEXT_PUBLIC_WORKER_URL=${NEXT_PUBLIC_WORKER_URL:-}
      - WORKER_API_KEY=${WORKER_API_KEY:-changeme}
      # MinIO 配置（用于媒体文件和 MinIO Console 代理）
      - MINIO_ENDPOINT_HOST=minio
      - MINIO_ENDPOINT_PORT=9000
      - MINIO_CONSOLE_PORT=9001
      - MINIO_USE_SSL=false
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-minioadmin}
      - MINIO_BUCKET=${MINIO_BUCKET:-pis-photos}
      # 会话密钥（必须设置）
      - ALBUM_SESSION_SECRET=${ALBUM_SESSION_SECRET}
      # 轮询配置（standalone 模式使用轮询实现实时更新）
      - NEXT_PUBLIC_POLLING_INTERVAL=${NEXT_PUBLIC_POLLING_INTERVAL:-3000}
      - NEXT_PUBLIC_ADMIN_POLLING_INTERVAL=${NEXT_PUBLIC_ADMIN_POLLING_INTERVAL:-2000}
      # 日志配置
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - ENABLE_PRETTY_LOG=${ENABLE_PRETTY_LOG:-false}
    volumes:
      - pis_web_logs:/app/logs
      # 挂载项目根目录（只读），用于升级脚本访问
      # 注意：在生产环境，项目根目录通常在 /opt/pis-standalone
      # 如果 PROJECT_ROOT 环境变量未设置，使用相对路径 ../..（从 docker 目录向上两级）
      - ${PROJECT_ROOT:-../..}:/opt/pis-standalone:ro
    ports:
      # 唯一对外暴露端口，所有服务通过路径访问
      # 如需修改端口避免冲突，请同时更新环境变量 NEXT_PUBLIC_APP_URL
      - "8081:3000" # HTTP 使用 8081（避开 80 端口冲突）
      # HTTPS 由内网穿透服务处理，不需要暴露 443
    depends_on:
      postgres:
        condition: service_healthy
      worker:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - pis-network
    healthcheck:
      # 使用 curl（Alpine 镜像默认包含，无需安装）
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ==================== Nginx 已移除 ====================
  # Nginx 功能已集成到 Next.js Web 容器中
  # - 媒体文件代理：/media/* -> /app/media/[...path]/route.ts
  # - MinIO Console 代理：/minio-console/* -> /app/minio-console/[...path]/route.ts
  # - Worker API 代理：/api/worker/* -> /app/api/worker/[...path]/route.ts
  #
  # 注意：
  # - MinIO Console 的 WebSocket 功能不支持通过 Next.js 代理
  # - 如需访问 MinIO Console，可以临时暴露 MinIO Console 端口（仅本地访问）
  #   或使用主机 Nginx 代理 MinIO Console
