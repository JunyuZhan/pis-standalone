name: pis

version: '3.8'

# ============================================
# PIS 完全自托管部署配置
#
# 包含服务：
# - PostgreSQL: 数据库
# - MinIO: 对象存储
# - Redis: 任务队列/缓存
# - Web: Next.js 前端
# - Worker: 图片处理服务
# - Nginx: 反向代理
#
# 端口说明：
# - 80/443: Nginx (HTTP/HTTPS)
# - 5432: PostgreSQL (仅本地)
# - 9000: MinIO API (仅本地)
# - 9001: MinIO Console (仅本地)
# ============================================

networks:
  pis-network:
    driver: bridge
    name: pis-network

volumes:
  pis_postgres_data:
    name: pis_postgres_data
  pis_minio_data:
    name: pis_minio_data
  pis_redis_data:
    name: pis_redis_data
  pis_nginx_logs:
    name: pis_nginx_logs
  pis_worker_logs:
    name: pis_worker_logs
  pis_web_logs:
    name: pis_web_logs
  # Let's Encrypt 证书（使用 certbot 时自动创建）
  pis_certs:
    name: pis_certs

services:
  # ==================== 数据库 ====================
  postgres:
    image: postgres:16-alpine
    container_name: pis-postgres
    env_file:
      - ../.env
    environment:
      # PostgreSQL 默认配置（可被 .env 覆盖）
      POSTGRES_DB: ${POSTGRES_DB:-pis}
      POSTGRES_USER: ${POSTGRES_USER:-pis}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - pis_postgres_data:/var/lib/postgresql/data
      # 数据库初始化脚本（如果需要）
      - ./init-postgresql-db.sql:/docker-entrypoint-initdb.d/init-postgresql-db.sql:ro
    ports:
      - "127.0.0.1:5432:5432"
    restart: unless-stopped
    networks:
      - pis-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-pis} -d ${POSTGRES_DB:-pis}"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==================== 对象存储 ====================
  minio:
    image: minio/minio:RELEASE.2025-04-22T22-12-26Z
    container_name: pis-minio
    env_file:
      - ../.env
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:-minioadmin}
    volumes:
      - pis_minio_data:/data
    command: server /data --console-address ":9001"
    ports:
      - "127.0.0.1:9000:9000"  # API
      - "127.0.0.1:9001:9001"  # 控制台
    restart: unless-stopped
    networks:
      - pis-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # MinIO Bucket 初始化
  minio-init:
    image: minio/mc:latest
    container_name: pis-minio-init
    env_file:
      - ../.env
    depends_on:
      minio:
        condition: service_healthy
    networks:
      - pis-network
    environment:
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
    entrypoint: >
      /bin/sh -c "
      sleep 5;
      mc alias set pis http://minio:9000 $${MINIO_ACCESS_KEY} $${MINIO_SECRET_KEY};
      mc mb pis/pis-photos --ignore-existing;
      # 创建子目录并设置不同的访问权限
      mc mb pis/pis-photos/processed --ignore-existing;
      mc mb pis/pis-photos/raw --ignore-existing;
      # 只公开 processed 目录（缩略图和预览图可以公开访问）
      mc anonymous set download pis/pis-photos/processed/;
      # raw 目录（原图）需要通过应用控制访问
      mc anonymous set off pis/pis-photos/raw/;
      echo 'MinIO bucket initialized with access policies';
      exit 0;
      "

  # ==================== 任务队列 ====================
  redis:
    image: redis:7-alpine
    container_name: pis-redis
    volumes:
      - pis_redis_data:/data
    command: redis-server --appendonly yes
    ports:
      - "127.0.0.1:6379:6379"
    restart: unless-stopped
    networks:
      - pis-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==================== 图片处理 Worker ====================
  worker:
    build:
      context: ..
      dockerfile: docker/worker.Dockerfile
    container_name: pis-worker
    env_file:
      - ../.env
    environment:
      # 数据库连接模式（postgresql = 直连 PostgreSQL，supabase = 使用 Supabase）
      - DATABASE_TYPE=${DATABASE_TYPE:-postgresql}
      # PostgreSQL 直连配置（DATABASE_TYPE=postgresql 时使用）
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_NAME=${POSTGRES_DB:-pis}
      - DATABASE_USER=${POSTGRES_USER:-pis}
      - DATABASE_PASSWORD=${POSTGRES_PASSWORD:-changeme}
      # Supabase 配置（DATABASE_TYPE=supabase 时使用，或留空使用 PostgreSQL）
      - SUPABASE_URL=${SUPABASE_URL:-}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY:-}
      # MinIO
      - MINIO_ENDPOINT_HOST=minio
      - MINIO_ENDPOINT_PORT=9000
      - MINIO_USE_SSL=false
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-minioadmin}
      - MINIO_BUCKET=${MINIO_BUCKET:-pis-photos}
      # Storage 配置
      - STORAGE_TYPE=minio
      - STORAGE_ENDPOINT=minio
      - STORAGE_PORT=9000
      - STORAGE_USE_SSL=false
      - STORAGE_ACCESS_KEY=${MINIO_ACCESS_KEY:-minioadmin}
      - STORAGE_SECRET_KEY=${MINIO_SECRET_KEY:-minioadmin}
      - STORAGE_BUCKET=${MINIO_BUCKET:-pis-photos}
      # Redis
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # Worker 配置
      - NODE_ENV=production
      - HTTP_PORT=3001
      - WORKER_API_KEY=${WORKER_API_KEY:-changeme}
      # 存储公网 URL
      - STORAGE_PUBLIC_URL=${STORAGE_PUBLIC_URL:-https://${DOMAIN:-localhost}/media}
      - MINIO_PUBLIC_URL=${MINIO_PUBLIC_URL:-https://${DOMAIN:-localhost}/media}
      # 告警配置
      - ALERT_ENABLED=${ALERT_ENABLED:-true}
      - ALERT_TYPE=${ALERT_TYPE:-log}
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - pis-network
    healthcheck:
      test: ["CMD", "node", "-e", "console.log('healthy')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==================== Next.js 前端 ====================
  web:
    build:
      context: ..
      dockerfile: docker/web.Dockerfile
      args:
        NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL:-https://${DOMAIN:-localhost}}
        NEXT_PUBLIC_MEDIA_URL: ${NEXT_PUBLIC_MEDIA_URL:-https://${DOMAIN:-localhost}/media}
        NEXT_PUBLIC_PHOTOGRAPHER_NAME: ${NEXT_PUBLIC_PHOTOGRAPHER_NAME:-PIS Photography}
        NEXT_PUBLIC_PHOTOGRAPHER_TAGLINE: ${NEXT_PUBLIC_PHOTOGRAPHER_TAGLINE:-专业活动摄影}
        NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL:-}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY:-}
        NEXT_PUBLIC_POLLING_INTERVAL: ${NEXT_PUBLIC_POLLING_INTERVAL:-3000}
        NEXT_PUBLIC_ADMIN_POLLING_INTERVAL: ${NEXT_PUBLIC_ADMIN_POLLING_INTERVAL:-2000}
    container_name: pis-web
    env_file:
      - ../.env
    environment:
      # 认证模式（custom = 自定义认证，推荐；留空 = Supabase，向后兼容）
      - AUTH_MODE=${AUTH_MODE:-custom}
      - AUTH_JWT_SECRET=${AUTH_JWT_SECRET}
      # 数据库连接
      - DATABASE_TYPE=${DATABASE_TYPE:-postgresql}
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_NAME=${POSTGRES_DB:-pis}
      - DATABASE_USER=${POSTGRES_USER:-pis}
      - DATABASE_PASSWORD=${POSTGRES_PASSWORD:-changeme}
      # Supabase（如果使用）
      - SUPABASE_URL=${SUPABASE_URL:-}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY:-}
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL:-}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY:-}
      # 应用配置
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL:-https://${DOMAIN:-localhost}}
      - NEXT_PUBLIC_MEDIA_URL=${NEXT_PUBLIC_MEDIA_URL:-https://${DOMAIN:-localhost}/media}
      - NEXT_PUBLIC_PHOTOGRAPHER_NAME=${NEXT_PUBLIC_PHOTOGRAPHER_NAME:-PIS Photography}
      - NEXT_PUBLIC_PHOTOGRAPHER_TAGLINE=${NEXT_PUBLIC_PHOTOGRAPHER_TAGLINE:-专业活动摄影}
      # Worker API（Docker 内部网络使用服务名）
      - WORKER_URL=http://worker:3001
      - NEXT_PUBLIC_WORKER_URL=${NEXT_PUBLIC_WORKER_URL:-}
      - WORKER_API_KEY=${WORKER_API_KEY:-changeme}
      # 会话密钥（必须设置）
      - ALBUM_SESSION_SECRET=${ALBUM_SESSION_SECRET}
      # 轮询配置（替代 Supabase Realtime）
      - NEXT_PUBLIC_POLLING_INTERVAL=${NEXT_PUBLIC_POLLING_INTERVAL:-3000}
      - NEXT_PUBLIC_ADMIN_POLLING_INTERVAL=${NEXT_PUBLIC_ADMIN_POLLING_INTERVAL:-2000}
      # 日志配置
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - ENABLE_PRETTY_LOG=${ENABLE_PRETTY_LOG:-false}
    volumes:
      - pis_web_logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      worker:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - pis-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ==================== Nginx 反向代理 ====================
  nginx:
    image: nginx:alpine
    container_name: pis-nginx
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - pis_nginx_logs:/var/log/nginx
      - pis_certs:/etc/letsencrypt:ro
    ports:
      - "8080:80"    # HTTP 使用 8080（配合 frpc/ddnsto 内网穿透）
      # HTTPS 由内网穿透服务处理，不需要暴露 443
      # - "443:443"
    depends_on:
      - web
      - minio
      - worker
    restart: unless-stopped
    networks:
      - pis-network
